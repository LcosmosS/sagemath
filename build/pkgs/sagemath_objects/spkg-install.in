cd src

export PIP_NO_INDEX=true

if [ -r vendor.txt ]; then
    export PIP_FIND_LINKS="file://$SAGE_DISTFILES"
    vendoring sync
fi

export PIP_FIND_LINKS="file://$SAGE_SPKG_WHEELS"

if [ "$SAGE_WHEELS" = yes ]; then
    rm -Rf build
    # First build the sdist, then build the wheel from the sdist.
    # https://pypa-build.readthedocs.io/en/latest/#python--m-build
    # This makes sure that the sdist is complete.
    DIST_DIR="$(mktemp -d)"
    python3 -m build --outdir "$DIST_DIR"/dist . || sdh_die "Failure building sdist and wheel"
    ls -l "$DIST_DIR"/dist/*.tar.gz
    if [ "$SAGE_EDITABLE" = yes ]; then
        # Do not install the wheel
        wheel=$(cd "$DIST_DIR" && sdh_store_wheel . >&2 && echo $wheel)
    else
        wheel=$(cd "$DIST_DIR" && sdh_store_and_pip_install_wheel . >&2 && echo $wheel)
    fi
    ls -l "$wheel"
fi
